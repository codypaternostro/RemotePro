name: Publish Module
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      # Ensure BuildHelpers is installed
      - name: Install BuildHelpers
        shell: pwsh
        run: Install-Module -Name BuildHelpers -Force -Scope CurrentUser

      # Get current and new versions
      - name: Check if version is bumped
        id: check_if_versions_bumped
        shell: pwsh
        run: |
          [version]$GalleryVersion = Get-NextNugetPackageVersion -Name RemotePro -ErrorAction Stop
          [version]$GithubVersion = Get-MetaData -Path ./RemotePro/RemotePro.psd1 -PropertyName ModuleVersion -ErrorAction Stop
          $bumped = $GithubVersion -gt $GalleryVersion

          # Fix for setting output in GitHub Actions
          "version_bumped=$bumped" | Out-File -FilePath $Env:GITHUB_OUTPUT -Append

      - name: Publish to PSGallery
        shell: pwsh
        if: steps.check_if_versions_bumped.outputs.version_bumped == 'true'
        env:
          PSGALLERY_API_KEY: ${{ secrets.PS_GALLERY_KEY }}
        run: ./build.ps1 -Task Publish -Bootstrap

